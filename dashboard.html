<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouCan Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #000000;
            --dark-gray: #66666E;
            --medium-gray: #9999A1;
            --light-gray: #E6E6E9;
            --off-white: #F4F4F6;
            --white: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #dc2626;
            --info: #3b82f6;
            --text-primary: #1a1a1a;
            --text-secondary: #66666E;
            --border-color: #E6E6E9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--off-white);
            color: var(--text-primary);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--black);
            color: var(--white);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-logo {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .sidebar-link i {
            width: 20px;
            font-size: 1.1rem;
        }

        .notification-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--error);
            color: var(--white);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: translateY(-50%) scale(1);
            }

            50% {
                transform: translateY(-50%) scale(1.1);
            }
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }

        .top-header {
            background: var(--white);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            padding: 10px 20px;
            background: var(--black);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: var(--dark-gray);
        }

        .header-btn.secondary {
            background: var(--off-white);
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
        }

        .stat-icon.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .chart-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chart-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .table-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .table-btn {
            padding: 8px 16px;
            background: var(--off-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .table-btn:hover {
            background: var(--black);
            color: var(--white);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: var(--off-white);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: var(--off-white);
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
        }

        .badge.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .action-btn.edit {
            background: var(--info);
            color: var(--white);
        }

        .action-btn.delete {
            background: var(--error);
            color: var(--white);
        }

        .action-btn.view {
            background: var(--success);
            color: var(--white);
        }

        .action-btn.info {
            background: var(--info);
            color: var(--white);
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--black);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #b91c1c;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-left: 4px solid var(--success);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 300px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        .notification-toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 968px) {
            .sidebar {
                left: -260px;
            }

            .main-content {
                margin-left: 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Notification Toast -->
    <div class="notification-toast" id="notificationToast">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-bell" style="font-size: 1.5rem; color: var(--success);"></i>
            <div>
                <div style="font-weight: 700; margin-bottom: 5px;" id="toastTitle">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);" id="toastMessage">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                </div>
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">YouCan Admin</div>
            <div class="sidebar-subtitle">Management Dashboard</div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="sidebar-link active" onclick="showSection('dashboard')"><i
                        class="fas fa-chart-line"></i> Dashboard</a></li>
            <li>
                <a href="#" class="sidebar-link" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Online Orders
                    <span class="notification-badge" id="onlineOrdersBadge" style="display: none;">0</span>
                </a>
            </li>
            <li>
                <a href="#" class="sidebar-link" onclick="showSection('pos-sales')">
                    <i class="fas fa-cash-register"></i> POS Sales
                    <span class="notification-badge" id="posSalesBadge" style="display: none;">0</span>
                </a>
            </li>
            <li><a href="pos.html" class="sidebar-link" target="_blank" style="background: rgba(16, 185, 129, 0.1);"><i
                        class="fas fa-store"></i> Open POS</a></li>
            <li><a href="#" class="sidebar-link" onclick="showSection('products')"><i class="fas fa-tag"></i>
                    Products</a></li>
            <li><a href="#" class="sidebar-link" onclick="showSection('customers')"><i class="fas fa-users"></i>
                    Customers</a></li>
            <li><a href="index.html" class="sidebar-link"><i class="fas fa-globe"></i> View Website</a></li>
            <!-- ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ù‚Ø¨Ù„ </ul> -->
            <li><a href="#" class="sidebar-link" onclick="logout()"
                    style="background: rgba(220, 38, 38, 0.1); color: #dc2626;">
                    <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </a></li>

        </ul>
    </aside>

    <main class="main-content">
        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard-section">
            <div class="top-header">
                <div>
                    <h1 class="page-title">Dashboard</h1>
                    <p style="color: var(--text-secondary); margin-top: 5px;">Welcome back, Admin</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn secondary" onclick="exportData()"><i class="fas fa-download"></i> Export
                        Excel</button>
                    <button class="header-btn" onclick="refreshDashboard()"><i class="fas fa-sync"></i> Refresh</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="totalRevenue">0 EGP</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> <span id="revenueChange">Loading...</span>
                            </div>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-value" id="totalOrders">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-shopping-cart"></i> <span id="pendingOrders">0</span> pending
                            </div>
                        </div>
                        <div class="stat-icon info">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value" id="totalProducts">0</div>
                            <div class="stat-change">
                                <i class="fas fa-tag"></i> <span id="activeProducts">0</span> active
                            </div>
                        </div>
                        <div class="stat-icon info">
                            <i class="fas fa-warehouse"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Customers</div>
                            <div class="stat-value" id="totalCustomers">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-users"></i> Active
                            </div>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Sales Overview</div>
                        <div class="chart-subtitle">Last 7 days</div>
                    </div>
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Order Status</div>
                        <div class="chart-subtitle">Distribution</div>
                    </div>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Recent Orders</div>
                    <button class="table-btn" onclick="showSection('orders')">View All</button>
                </div>
                <div id="recentOrdersContainer"></div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="content-section" id="orders-section">
            <div class="top-header">
                <h1 class="page-title">Online Orders Management</h1>
                <div class="header-actions">
                    <select class="form-select" onchange="filterOrders(this.value)" style="max-width: 200px;">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button class="header-btn" onclick="exportData()"><i class="fas fa-download"></i> Export
                        Excel</button>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">All Online Orders</div>
                </div>
                <div id="ordersTableContainer"></div>
            </div>
        </div>

        <!-- POS Sales Section -->
        <div class="content-section" id="pos-sales-section">
            <div class="top-header">
                <div>
                    <h1 class="page-title">Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ (POS)</h1>
                    <p style="color: var(--text-secondary); margin-top: 5px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</p>
                </div>
                <div class="header-actions">
                    <select class="form-select" onchange="filterPOSSales(this.value)" style="max-width: 200px;">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                        <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                        <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                    </select>
                    <button class="header-btn secondary" onclick="exportData()"><i class="fas fa-download"></i>
                        Export</button>
                    <button class="header-btn" onclick="window.open('pos.html', '_blank')">
                        <i class="fas fa-plus"></i> Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                            <div class="stat-value" id="posTodaySales">0 EGP</div>
                            <div class="stat-change positive">
                                <i class="fas fa-shopping-bag"></i> <span id="posTodayCount">0</span> Ø¹Ù…Ù„ÙŠØ©
                            </div>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-cash-register"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                            <div class="stat-value" id="posWeekSales">0 EGP</div>
                            <div class="stat-change">
                                <i class="fas fa-calendar-week"></i> <span id="posWeekCount">0</span> Ø¹Ù…Ù„ÙŠØ©
                            </div>
                        </div>
                        <div class="stat-icon info">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
                            <div class="stat-value" id="posMonthSales">0 EGP</div>
                            <div class="stat-change">
                                <i class="fas fa-calendar-alt"></i> <span id="posMonthCount">0</span> Ø¹Ù…Ù„ÙŠØ©
                            </div>
                        </div>
                        <div class="stat-icon warning">
                            <i class="fas fa-store"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                            <div class="stat-value" id="posAvgSale">0 EGP</div>
                            <div class="stat-change positive">
                                <i class="fas fa-receipt"></i> Ù„Ù„ÙØ§ØªÙˆØ±Ø©
                            </div>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Ø¬Ù…ÙŠØ¹ Ù…Ø¨ÙŠØ¹Ø§Øª POS</div>
                    <input type="text" class="form-input" placeholder="Ø¨Ø­Ø«..." style="max-width: 300px;">
                </div>
                <div id="posSalesTableContainer"></div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="content-section" id="products-section">
            <div class="top-header">
                <h1 class="page-title">Products Management</h1>
                <div class="header-actions">
                    <button class="header-btn secondary" onclick="exportData()"><i class="fas fa-download"></i>
                        Export</button>
                    <button class="header-btn" onclick="showAddProductForm()"><i class="fas fa-plus"></i> Add
                        Product</button>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">All Products</div>
                </div>
                <div id="productsTableContainer"></div>
            </div>
        </div>

        <!-- Customers Section -->
        <div class="content-section" id="customers-section">
            <div class="top-header">
                <h1 class="page-title">Customers</h1>
                <button class="header-btn" onclick="exportData()"><i class="fas fa-download"></i> Export Excel</button>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Customer List</div>
                </div>
                <div id="customersTableContainer"></div>
            </div>
        </div>
    </main>
    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            </div>
            <form id="productForm" onsubmit="addProduct(event)">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                    <input type="text" name="name" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">SKU (ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬) *</label>
                    <input type="text" name="sku" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„ÙØ¦Ø© *</label>
                    <select name="category" class="form-select" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                        <option value="leggings">Leggings</option>
                        <option value="pants">Pants</option>
                        <option value="tops">Tops</option>
                        <option value="sets">Sets</option>
                        <option value="jackets">Jackets</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡) *</label>
                    <input type="number" name="price" step="0.01" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© *</label>
                    <input type="number" name="stock" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL) *</label>
                    <input type="url" name="imageUrl" class="form-input" placeholder="https://example.com/image.jpg"
                        required>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ imgur.com Ø£Ùˆ
                        imgbb.com</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                    <textarea name="description" rows="3" class="form-textarea"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label>
                    <input type="text" name="sizes" class="form-input" placeholder="S,M,L,XL" value="S,M,L,XL">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†</label>
                    <input type="text" name="colorName" class="form-input" placeholder="Ø£Ø³ÙˆØ¯" value="Default">
                </div>

                <div class="form-group">
                    <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ† (Hex)</label>
                    <input type="color" name="colorHex" class="form-input" value="#000000">
                </div>

                <div class="form-group">
                    <label class="form-label">Tag (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select name="tag" class="form-select">
                        <option value="">Ø¨Ø¯ÙˆÙ†</option>
                        <option value="Best Seller">Best Seller</option>
                        <option value="New">New</option>
                        <option value="Sale">Sale</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="submitBtn">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
                    </button>
                    <button type="button" class="btn-secondary" onclick="closeAddProductForm()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Return Modal -->
    <div class="modal" id="returnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø§Ø³ØªØ±Ø¬Ø§Ø¹/Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬</h2>
            </div>
            <form id="returnForm" onsubmit="processReturn(event)">
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
                    <select class="form-select" name="returnType" required>
                        <option value="return">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„</option>
                        <option value="exchange">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</option>
                        <option value="partial">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø³Ø¨Ø¨ *</label>
                    <textarea class="form-textarea" name="returnReason" rows="3" required
                        placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ±Ø¯</label>
                    <input type="number" class="form-input" name="refundAmount" id="refundAmount" readonly>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="returnSubmitBtn">
                        <i class="fas fa-undo"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    </button>
                    <button type="button" class="btn-secondary" onclick="closeReturnModal()">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer History Modal -->
    <div class="modal" id="customerHistoryModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="customerHistoryTitle">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                <button onclick="closeCustomerHistory()"
                    style="position: absolute; left: 20px; top: 20px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>

            <div style="background: var(--off-white); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø§Ù„Ø§Ø³Ù…</div>
                        <div style="font-weight: 700;" id="customerHistoryName">-</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                        </div>
                        <div style="font-weight: 700;" id="customerHistoryPhone">-</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø§Ù„Ø¨Ø±ÙŠØ¯
                            Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                        <div style="font-weight: 700;" id="customerHistoryEmail">-</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                        <div style="font-weight: 700; color: var(--info);" id="customerHistoryOrders">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            Ø§Ù„Ø¥Ù†ÙØ§Ù‚</div>
                        <div style="font-weight: 700; color: var(--success);" id="customerHistorySpent">0 EGP</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Ø¹Ø¶Ùˆ Ù…Ù†Ø°</div>
                        <div style="font-weight: 700;" id="customerHistorySince">-</div>
                    </div>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 15px; font-size: 1.2rem;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                <div id="customerOrdersHistory" style="max-height: 400px; overflow-y: auto;"></div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn-secondary" onclick="closeCustomerHistory()">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Audio element for notification sound -->
    <audio id="notificationSound" preload="auto">
        <source
            src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKXh8LZlHQc5k9n0yn0vBSF1xe/glEILElyx6OyrWBUIRJre8r9uIgUsgs/z2oo3Bxppv/LonU8ND1Co5fC4aR4HOZXb9s2AMAUdbcvv45hFDBBctOjtrVoWCEKY3O+/cSQGK4DN8diJNggbaL/y6J5RDRBRqObwuWoeBzqV2fbNgjEFHG3M7+OZRQ0QW7Pn7K1bGAg/ltvvvnEmBSp/zPDXiDUIGme+8emdUA0PUKrl8LdqHwc7ltv3zoIyBRttzO7hmEQMEFux5+ytWRcJP5XZ8L1wJAUpfs3w1og2CBlmvO/om00MDk+l4e+1ZR0GOpTY88p+LgUgdMLu3pJBCw9Y"
            type="audio/wav">
    </audio>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://zyhopxnmysoicjkceboy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5aG9weG5teXNvaWNqa2NlYm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzQ0NDksImV4cCI6MjA3NTkxMDQ0OX0.CnvXooTiR4nSY683dDdK3DihVSZU6JvGsgDFJ9K_YPo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let ordersData = [];
        let productsData = [];
        let customersData = [];
        let posSalesData = [];
        let currentReturnSale = null;
        let lastOrderCount = 0;
        let lastPOSCount = 0;

        // Notification System
        function showNotification(title, message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            toast.style.borderLeftColor = type === 'success' ? 'var(--success)' :
                type === 'error' ? 'var(--error)' :
                    type === 'warning' ? 'var(--warning)' : 'var(--info)';

            toast.classList.add('show');

            // Play notification sound
            const sound = document.getElementById('notificationSound');
            sound.play().catch(e => console.log('Audio play prevented'));

            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Check for new orders (runs every 30 seconds)
        async function checkNewOrders() {
            try {
                const { data: orders } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                const onlineOrders = orders.filter(o => o.governorate !== 'Store');
                const posOrders = orders.filter(o => o.governorate === 'Store');

                // Check for new online orders
                if (onlineOrders.length > lastOrderCount && lastOrderCount > 0) {
                    const newOrders = onlineOrders.length - lastOrderCount;
                    showNotification('Ø·Ù„Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¬Ø¯ÙŠØ¯! ğŸ›’', `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${newOrders} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹`);
                    updateOrdersBadge(newOrders);
                }

                // Check for new POS sales
                if (posOrders.length > lastPOSCount && lastPOSCount > 0) {
                    const newSales = posOrders.length - lastPOSCount;
                    showNotification('Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©! ğŸ’°', `ØªÙ… Ø¥ØªÙ…Ø§Ù… ${newSales} Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ù…Ù† POS`);
                    updatePOSBadge(newSales);
                }

                lastOrderCount = onlineOrders.length;
                lastPOSCount = posOrders.length;

            } catch (error) {
                console.error('Error checking orders:', error);
            }
        }

        function updateOrdersBadge(count) {
            const badge = document.getElementById('onlineOrdersBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updatePOSBadge(count) {
            const badge = document.getElementById('posSalesBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Load All Data
        async function loadAllData() {
            try {
                const [orders, products, customers] = await Promise.all([
                    supabase.from('orders').select('*').order('created_at', { ascending: false }),
                    supabase.from('products').select('*').order('name'),
                    supabase.from('customers').select('*').order('total_spent', { ascending: false })
                ]);

                ordersData = orders.data || [];
                productsData = products.data || [];
                customersData = customers.data || [];

                // Initialize counters
                if (lastOrderCount === 0) {
                    lastOrderCount = ordersData.filter(o => o.governorate !== 'Store').length;
                    lastPOSCount = ordersData.filter(o => o.governorate === 'Store').length;
                }

                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }

        async function loadPOSSales() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('governorate', 'Store')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                posSalesData = data || [];
                return posSalesData;
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        function calculateAnalytics() {
            const totalRevenue = ordersData.reduce((sum, order) => sum + order.total, 0);
            const totalOrders = ordersData.length;
            const pendingOrders = ordersData.filter(o => o.status === 'pending').length;

            return {
                totalRevenue,
                totalOrders,
                pendingOrders,
                totalProducts: productsData.length,
                totalCustomers: customersData.length
            };
        }

        function calculatePOSStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const todaySales = posSalesData.filter(s => new Date(s.created_at) >= today);
            const weekSales = posSalesData.filter(s => new Date(s.created_at) >= weekStart);
            const monthSales = posSalesData.filter(s => new Date(s.created_at) >= monthStart);

            const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
            const weekTotal = weekSales.reduce((sum, s) => sum + s.total, 0);
            const monthTotal = monthSales.reduce((sum, s) => sum + s.total, 0);

            const avgSale = posSalesData.length > 0 ?
                (posSalesData.reduce((sum, s) => sum + s.total, 0) / posSalesData.length).toFixed(0) : 0;

            return {
                todayTotal, todayCount: todaySales.length,
                weekTotal, weekCount: weekSales.length,
                monthTotal, monthCount: monthSales.length,
                avgSale
            };
        }

        async function renderDashboard() {
            document.getElementById('recentOrdersContainer').innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            await loadAllData();
            const analytics = calculateAnalytics();

            document.getElementById('totalRevenue').textContent = `${analytics.totalRevenue.toLocaleString()} EGP`;
            document.getElementById('totalOrders').textContent = analytics.totalOrders;
            document.getElementById('pendingOrders').textContent = analytics.pendingOrders;
            document.getElementById('totalProducts').textContent = analytics.totalProducts;
            document.getElementById('activeProducts').textContent = analytics.totalProducts;
            document.getElementById('totalCustomers').textContent = analytics.totalCustomers;
            document.getElementById('revenueChange').textContent = 'Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª';

            renderRecentOrders();
            initDashboardCharts();
        }

        function renderRecentOrders() {
            const container = document.getElementById('recentOrdersContainer');
            const recent = ordersData.filter(o => o.governorate !== 'Store').slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recent.map(order => `
                            <tr>
                                <td><strong>${order.order_number}</strong></td>
                                <td>${order.customer_name}</td>
                                <td>${new Date(order.created_at).toLocaleDateString('ar-EG')}</td>
                                <td><strong>${order.total} EGP</strong></td>
                                <td><span class="badge ${getStatusClass(order.status)}">${getStatusArabic(order.status)}</span></td>
                                <td>
                                    <select class="form-select" onchange="updateOrderStatus(${order.id}, this.value)" style="padding: 6px; font-size: 0.8rem;">
                                        <option value="${order.status}" selected>${getStatusArabic(order.status)}</option>
                                        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                        <option value="processing">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                        <option value="shipped">ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                                        <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                        <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function renderOrders(filter = 'all') {
            const container = document.getElementById('ordersTableContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            await loadAllData();
            let filtered = ordersData.filter(o => o.governorate !== 'Store');
            if (filter !== 'all') filtered = filtered.filter(o => o.status === filter);

            // Reset badge when viewing orders
            updateOrdersBadge(0);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(order => `
                            <tr>
                                <td><strong>${order.order_number}</strong></td>
                                <td>${order.customer_name}</td>
                                <td>${order.customer_phone}</td>
                                <td>${new Date(order.created_at).toLocaleDateString('ar-EG')}</td>
                                <td>${order.items.length} Ù…Ù†ØªØ¬Ø§Øª</td>
                                <td><strong>${order.total} EGP</strong></td>
                                <td>
                                    <select class="badge ${getStatusClass(order.status)}" onchange="updateOrderStatus(${order.id}, this.value)" style="border: none; cursor: pointer; background: transparent;">
                                        <option value="${order.status}" selected>${getStatusArabic(order.status)}</option>
                                        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                        <option value="processing">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                        <option value="shipped">ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                                        <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                                        <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                                    </select>
                                </td>
                                <td>
                                    <div class="action-btns">
                                        <button class="action-btn view" onclick="viewOrderDetails(${order.id})"><i class="fas fa-eye"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        async function renderPOSSales(filter = 'all') {
            const container = document.getElementById('posSalesTableContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            await loadPOSSales();
            const stats = calculatePOSStats();

            document.getElementById('posTodaySales').textContent = `${stats.todayTotal.toLocaleString()} EGP`;
            document.getElementById('posTodayCount').textContent = stats.todayCount;
            document.getElementById('posWeekSales').textContent = `${stats.weekTotal.toLocaleString()} EGP`;
            document.getElementById('posWeekCount').textContent = stats.weekCount;
            document.getElementById('posMonthSales').textContent = `${stats.monthTotal.toLocaleString()} EGP`;
            document.getElementById('posMonthCount').textContent = stats.monthCount;
            document.getElementById('posAvgSale').textContent = `${stats.avgSale} EGP`;

            // Reset badge when viewing POS sales
            updatePOSBadge(0);

            let filtered = posSalesData;
            const now = new Date();

            if (filter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filtered = posSalesData.filter(s => new Date(s.created_at) >= today);
            } else if (filter === 'week') {
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                filtered = posSalesData.filter(s => new Date(s.created_at) >= weekStart);
            } else if (filter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filtered = posSalesData.filter(s => new Date(s.created_at) >= monthStart);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-cash-register"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø¯ÙØ¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(sale => {
                const payment = sale.notes ? sale.notes.replace('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ', '').split('\n')[0] : '-';
                return `
                            <tr>
                                <td><strong>${sale.order_number}</strong></td>
                                <td>${sale.customer_name}</td>
                                <td>${new Date(sale.created_at).toLocaleString('ar-EG')}</td>
                                <td>${sale.items.length} Ù…Ù†ØªØ¬</td>
                                <td><strong>${sale.total} EGP</strong></td>
                                <td>${payment}</td>
                                <td><span class="badge ${getStatusClass(sale.status)}">${getStatusArabic(sale.status)}</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="action-btn view" onclick="viewSaleDetails(${sale.id})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn info" onclick="viewCustomerHistory('${sale.customer_phone}')" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…ÙŠÙ„">
                                            <i class="fas fa-user"></i>
                                        </button>
                                        ${sale.status === 'completed' ? `
                                            <button class="action-btn edit" onclick="openReturnModal(${sale.id})" title="Ø§Ø³ØªØ±Ø¬Ø§Ø¹">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
            }).join('')}
                    </tbody>
                </table>
            `;
        }

        function viewSaleDetails(saleId) {
            const sale = posSalesData.find(s => s.id === saleId);
            if (!sale) return;

            const payment = sale.notes ? sale.notes.replace('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ', '').split('\n')[0] : '-';

            let details = `ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©\n\n`;
            details += `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${sale.order_number}\n`;
            details += `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${sale.customer_name}\n`;
            details += `Ø§Ù„Ù‡Ø§ØªÙ: ${sale.customer_phone}\n`;
            details += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(sale.created_at).toLocaleString('ar-EG')}\n`;
            details += `Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${payment}\n\n`;
            details += `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n${'â”€'.repeat(40)}\n`;

            sale.items.forEach((item, idx) => {
                details += `${idx + 1}. ${item.name}\n`;
                details += `   ${item.price} Ã— ${item.quantity} = ${item.price * item.quantity} Ø¬Ù†ÙŠÙ‡\n`;
            });

            details += `${'â”€'.repeat(40)}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sale.total} Ø¬Ù†ÙŠÙ‡`;
            alert(details);
        }

        function openReturnModal(saleId) {
            const sale = posSalesData.find(s => s.id === saleId);
            if (!sale) return;

            currentReturnSale = sale;
            document.getElementById('refundAmount').value = sale.total;
            document.getElementById('returnModal').classList.add('active');
        }

        function closeReturnModal() {
            document.getElementById('returnModal').classList.remove('active');
            document.getElementById('returnForm').reset();
            currentReturnSale = null;
        }

        async function processReturn(event) {
            event.preventDefault();
            if (!currentReturnSale) return;

            const submitBtn = document.getElementById('returnSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

            try {
                const formData = new FormData(event.target);
                const returnType = formData.get('returnType');
                const returnReason = formData.get('returnReason');

                let newStatus = 'cancelled';
                if (returnType === 'exchange') newStatus = 'processing';

                const returnNote = `\n\n[${returnType === 'return' ? 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹' : returnType === 'exchange' ? 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„' : 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ'}]\nØ§Ù„Ø³Ø¨Ø¨: ${returnReason}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-EG')}`;

                const { error } = await supabase
                    .from('orders')
                    .update({
                        status: newStatus,
                        notes: (currentReturnSale.notes || '') + returnNote
                    })
                    .eq('id', currentReturnSale.id);

                if (error) throw error;

                if (returnType === 'return' || returnType === 'partial') {
                    for (const item of currentReturnSale.items) {
                        const product = productsData.find(p => p.id === item.productId);
                        if (product) {
                            await supabase
                                .from('products')
                                .update({ stock: product.stock + item.quantity })
                                .eq('id', item.productId);
                        }
                    }
                }

                showNotification('ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹/Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„');
                closeReturnModal();
                renderPOSSales();
                loadAllData();

            } catch (error) {
                showNotification('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-undo"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
            }
        }

        async function renderProducts() {
            const container = document.getElementById('productsTableContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            await loadAllData();

            if (productsData.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th>SKU</th>
                            <th>Ø§Ù„ÙØ¦Ø©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productsData.map(product => `
                            <tr>
                                <td><img src="${product.image_url || 'https://via.placeholder.com/50'}" class="product-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                                <td><strong>${product.name}</strong></td>
                                <td>${product.sku}</td>
                                <td>${product.category}</td>
                                <td>${product.price} EGP</td>
                                <td><strong>${product.stock || 0}</strong></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="action-btn delete" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function renderCustomers() {
            const container = document.getElementById('customersTableContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            await loadAllData();

            if (customersData.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</p></div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                            <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${customersData.map(customer => `
                            <tr>
                                <td><strong>${customer.name}</strong></td>
                                <td>
                                    <a href="javascript:void(0)" onclick="viewCustomerHistory('${customer.phone}')" 
                                       style="color: var(--info); text-decoration: none; font-weight: 600;">
                                        ${customer.phone}
                                    </a>
                                </td>
                                <td>${customer.email || '-'}</td>
                                <td>${customer.governorate || '-'}</td>
                                <td><span class="badge info">${customer.total_orders}</span></td>
                                <td><strong style="color: var(--success);">${customer.total_spent.toLocaleString()} EGP</strong></td>
                                <td>${new Date(customer.created_at).toLocaleDateString('ar-EG')}</td>
                                <td>
                                    <div class="action-btns">
                                        <button class="action-btn view" onclick="viewCustomerHistory('${customer.phone}')" title="Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®">
                                            <i class="fas fa-history"></i>
                                        </button>
                                        <button class="action-btn edit" onclick="sendOfferToCustomer('${customer.phone}', '${customer.name}')" title="Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function viewCustomerHistory(customerPhone) {
            try {
                const customer = customersData.find(c => c.phone === customerPhone);
                if (!customer) {
                    alert('Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const { data: customerOrders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('customer_phone', customerPhone)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                document.getElementById('customerHistoryTitle').textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name}`;
                document.getElementById('customerHistoryName').textContent = customer.name;
                document.getElementById('customerHistoryPhone').textContent = customer.phone;
                document.getElementById('customerHistoryEmail').textContent = customer.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                document.getElementById('customerHistoryOrders').textContent = customer.total_orders;
                document.getElementById('customerHistorySpent').textContent = `${customer.total_spent.toLocaleString()} EGP`;
                document.getElementById('customerHistorySince').textContent = new Date(customer.created_at).toLocaleDateString('ar-EG');

                const ordersContainer = document.getElementById('customerOrdersHistory');

                if (customerOrders.length === 0) {
                    ordersContainer.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-bag"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p></div>';
                } else {
                    ordersContainer.innerHTML = customerOrders.map((order) => {
                        const isStore = order.governorate === 'Store';
                        return `
                            <div style="background: var(--white); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 1.05rem;">${order.order_number}</strong>
                                        <span class="badge ${isStore ? 'success' : 'info'}" style="margin-left: 10px;">
                                            ${isStore ? 'POS' : 'Online'}
                                        </span>
                                        <span class="badge ${getStatusClass(order.status)}">
                                            ${getStatusArabic(order.status)}
                                        </span>
                                    </div>
                                    <div style="text-align: left;">
                                        <div style="font-weight: 700; font-size: 1.1rem; color: var(--success);">
                                            ${order.total.toLocaleString()} EGP
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${new Date(order.created_at).toLocaleDateString('ar-EG')} ${new Date(order.created_at).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="border-top: 1px solid var(--border-color); padding-top: 10px;">
                                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.9rem;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</div>
                                    ${order.items.map((item, idx) => `
                                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9rem;">
                                            <span>${idx + 1}. ${item.name} ${item.color && item.size ? `(${item.color}, ${item.size})` : ''}</span>
                                            <span>${item.price} Ã— ${item.quantity} = <strong>${(item.price * item.quantity).toLocaleString()} EGP</strong></span>
                                        </div>
                                    `).join('')}
                                </div>

                                ${order.notes ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 0.85rem; color: var(--text-secondary);">
                                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('customerHistoryModal').classList.add('active');

            } catch (error) {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„');
            }
        }

        function closeCustomerHistory() {
            document.getElementById('customerHistoryModal').classList.remove('active');
        }

        function sendOfferToCustomer(customerPhone, customerName) {
            const message = prompt(
                `Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ø¥Ù„Ù‰: ${customerName}\n\n` +
                `Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ${customerPhone}\n\n` +
                `Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶:`
            );

            if (message && message.trim()) {
                const whatsappUrl = `https://wa.me/2${customerPhone.replace(/^0/, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');

                showNotification('ØªÙ… ÙØªØ­ WhatsApp', `Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ ${customerName}`);
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', orderId);

                if (error) throw error;
                await refreshDashboard();
                showNotification('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                showNotification('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨', 'error');
            }
        }

        function viewOrderDetails(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;

            let details = `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.order_number}\n\n`;
            details += `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${order.customer_name}\n`;
            details += `Ø§Ù„Ù‡Ø§ØªÙ: ${order.customer_phone}\n`;
            details += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.address}, ${order.governorate}\n\n`;
            details += `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n`;
            order.items.forEach((item, idx) => {
                details += `${idx + 1}. ${item.name} (${item.color}, ${item.size}) Ã— ${item.quantity} = ${item.price * item.quantity} EGP\n`;
            });
            details += `\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total} EGP`;
            alert(details);
        }

        function showAddProductForm() {
            document.getElementById('addProductModal').classList.add('active');
        }

        function closeAddProductForm() {
            document.getElementById('addProductModal').classList.remove('active');
            document.getElementById('productForm').reset();
        }

        async function addProduct(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

            try {
                const formData = new FormData(event.target);
                const sizesInput = formData.get('sizes');
                const sizesArray = sizesInput ? sizesInput.split(',').map(s => s.trim()) : ['S', 'M', 'L', 'XL'];

                const productData = {
                    name: formData.get('name'),
                    sku: formData.get('sku'),
                    category: formData.get('category'),
                    price: parseFloat(formData.get('price')),
                    stock: parseInt(formData.get('stock')),
                    reorder_level: 10,
                    description: formData.get('description'),
                    image_url: formData.get('imageUrl'),
                    sizes: sizesArray,
                    colors: [{
                        name: formData.get('colorName') || 'Default',
                        hex: formData.get('colorHex') || '#000000',
                        image: formData.get('imageUrl')
                    }],
                    tag: formData.get('tag') || ''
                };

                const { error } = await supabase
                    .from('products')
                    .insert([productData]);

                if (error) throw error;

                showNotification('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                closeAddProductForm();
                renderProducts();

            } catch (error) {
                showNotification('Ø®Ø·Ø£', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬';
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;
                showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬');
                renderProducts();
            } catch (error) {
                showNotification('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
            }
        }

        function getStatusClass(status) {
            const map = {
                'pending': 'warning',
                'processing': 'info',
                'shipped': 'info',
                'completed': 'success',
                'cancelled': 'error'
            };
            return map[status] || 'info';
        }

        function getStatusArabic(status) {
            const map = {
                'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                'shipped': 'ØªÙ… Ø§Ù„Ø´Ø­Ù†',
                'completed': 'Ù…ÙƒØªÙ…Ù„',
                'cancelled': 'Ù…Ù„ØºÙŠ'
            };
            return map[status] || status;
        }

        function initDashboardCharts() {
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬Ù†ÙŠÙ‡)',
                        data: [4200, 5300, 4800, 6200, 5800, 7100, 6500],
                        borderColor: '#000',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = {
                pending: ordersData.filter(o => o.status === 'pending').length,
                processing: ordersData.filter(o => o.status === 'processing').length,
                completed: ordersData.filter(o => o.status === 'completed').length,
                cancelled: ordersData.filter(o => o.status === 'cancelled').length
            };

            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts.processing, statusCounts.completed, statusCounts.cancelled],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // Excel Export Function (Ù…Ø®ØªØµØ±Ø© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        // Export Data to Excel - Full Version
        function exportData() {
            try {
                const wb = XLSX.utils.book_new();

                // ==================== Sheet 1: Orders ====================
                const ordersForExcel = ordersData.map(order => {
                    const itemsDetails = order.items.map(item =>
                        `${item.name} (${item.color || 'N/A'}, ${item.size || 'N/A'}) Ã— ${item.quantity} = ${item.price * item.quantity} EGP`
                    ).join(' | ');

                    const orderType = order.governorate === 'Store' ? 'POS' : 'Online';
                    const paymentMethod = order.notes ? order.notes.split('\n')[0].replace('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ', '').replace('Payment: ', '') : '-';

                    return {
                        'Order Number': order.order_number,
                        'Order Type': orderType,
                        'Customer Name': order.customer_name,
                        'Phone': order.customer_phone,
                        'Email': order.customer_email || '-',
                        'Governorate': order.governorate,
                        'Address': order.address,
                        'Notes': order.notes ? order.notes.replace(/Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:.*?\n?/g, '').trim() : '-',
                        'Products Count': order.items.length,
                        'Products Details': itemsDetails,
                        'Total (EGP)': order.total,
                        'Payment Method': paymentMethod,
                        'Status': getStatusEnglish(order.status),
                        'Order Date': new Date(order.created_at).toLocaleString('en-US'),
                        'Last Update': new Date(order.updated_at || order.created_at).toLocaleString('en-US')
                    };
                });

                const ordersSheet = XLSX.utils.json_to_sheet(ordersForExcel);

                // Set column widths
                ordersSheet['!cols'] = [
                    { wch: 18 }, // Order Number
                    { wch: 10 }, // Order Type
                    { wch: 20 }, // Customer Name
                    { wch: 15 }, // Phone
                    { wch: 25 }, // Email
                    { wch: 15 }, // Governorate
                    { wch: 40 }, // Address
                    { wch: 30 }, // Notes
                    { wch: 12 }, // Products Count
                    { wch: 60 }, // Products Details
                    { wch: 12 }, // Total
                    { wch: 15 }, // Payment Method
                    { wch: 12 }, // Status
                    { wch: 20 }, // Order Date
                    { wch: 20 }  // Last Update
                ];

                XLSX.utils.book_append_sheet(wb, ordersSheet, 'Orders');

                // ==================== Sheet 2: Products ====================
                const productsForExcel = productsData.map(product => {
                    const colors = product.colors ? product.colors.map(c => c.name).join(', ') : '-';
                    const sizes = product.sizes ? product.sizes.join(', ') : '-';

                    return {
                        'SKU': product.sku,
                        'Product Name': product.name,
                        'Category': product.category,
                        'Price (EGP)': product.price,
                        'Stock Quantity': product.stock || 0,
                        'Reorder Level': product.reorder_level || 10,
                        'Available Colors': colors,
                        'Available Sizes': sizes,
                        'Description': product.description || '-',
                        'Tag': product.tag || '-',
                        'Image URL': product.image_url || '-',
                        'Created Date': new Date(product.created_at).toLocaleString('en-US'),
                        'Last Update': new Date(product.updated_at || product.created_at).toLocaleString('en-US')
                    };
                });

                const productsSheet = XLSX.utils.json_to_sheet(productsForExcel);

                productsSheet['!cols'] = [
                    { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                    { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 12 },
                    { wch: 50 }, { wch: 20 }, { wch: 20 }
                ];

                XLSX.utils.book_append_sheet(wb, productsSheet, 'Products');

                // ==================== Sheet 3: Customers ====================
                const customersForExcel = customersData.map(customer => ({
                    'Customer Name': customer.name,
                    'Phone': customer.phone,
                    'Email': customer.email || '-',
                    'Governorate': customer.governorate || '-',
                    'Total Orders': customer.total_orders,
                    'Total Spent (EGP)': customer.total_spent,
                    'Average Order Value': customer.total_orders > 0 ?
                        (customer.total_spent / customer.total_orders).toFixed(2) : 0,
                    'Customer Since': new Date(customer.created_at).toLocaleDateString('en-US')
                }));

                const customersSheet = XLSX.utils.json_to_sheet(customersForExcel);

                customersSheet['!cols'] = [
                    { wch: 25 }, { wch: 15 }, { wch: 30 }, { wch: 15 },
                    { wch: 12 }, { wch: 18 }, { wch: 18 }, { wch: 20 }
                ];

                XLSX.utils.book_append_sheet(wb, customersSheet, 'Customers');

                // ==================== Sheet 4: Summary & Analytics ====================
                const analytics = calculateAnalytics();
                const completedOrders = ordersData.filter(o => o.status === 'completed').length;
                const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
                const cancelledOrders = ordersData.filter(o => o.status === 'cancelled').length;
                const avgOrderValue = ordersData.length > 0 ?
                    (analytics.totalRevenue / ordersData.length).toFixed(2) : 0;

                // Calculate top products
                const productSales = {};
                ordersData.forEach(order => {
                    order.items.forEach(item => {
                        if (!productSales[item.name]) {
                            productSales[item.name] = { quantity: 0, revenue: 0 };
                        }
                        productSales[item.name].quantity += item.quantity;
                        productSales[item.name].revenue += item.price * item.quantity;
                    });
                });

                const topProducts = Object.entries(productSales)
                    .sort((a, b) => b[1].quantity - a[1].quantity)
                    .slice(0, 5);

                // Separate Online vs POS
                const onlineOrders = ordersData.filter(o => o.governorate !== 'Store');
                const posOrders = ordersData.filter(o => o.governorate === 'Store');
                const onlineRevenue = onlineOrders.reduce((sum, o) => sum + o.total, 0);
                const posRevenue = posOrders.reduce((sum, o) => sum + o.total, 0);

                const summaryData = [
                    { 'Metric': 'GENERAL STATISTICS', 'Value': '' },
                    { 'Metric': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'Value': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' },
                    { 'Metric': 'Total Revenue', 'Value': `${analytics.totalRevenue.toLocaleString()} EGP` },
                    { 'Metric': 'Total Orders', 'Value': analytics.totalOrders },
                    { 'Metric': 'Average Order Value', 'Value': `${avgOrderValue} EGP` },
                    { 'Metric': 'Total Products', 'Value': analytics.totalProducts },
                    { 'Metric': 'Total Customers', 'Value': analytics.totalCustomers },
                    { 'Metric': '', 'Value': '' },
                    { 'Metric': 'ORDER CHANNELS', 'Value': '' },
                    { 'Metric': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'Value': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' },
                    { 'Metric': 'Online Orders', 'Value': onlineOrders.length },
                    { 'Metric': 'Online Revenue', 'Value': `${onlineRevenue.toLocaleString()} EGP` },
                    { 'Metric': 'POS Orders', 'Value': posOrders.length },
                    { 'Metric': 'POS Revenue', 'Value': `${posRevenue.toLocaleString()} EGP` },
                    { 'Metric': '', 'Value': '' },
                    { 'Metric': 'ORDER STATUS', 'Value': '' },
                    { 'Metric': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'Value': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' },
                    { 'Metric': 'Completed Orders', 'Value': completedOrders },
                    { 'Metric': 'Pending Orders', 'Value': pendingOrders },
                    { 'Metric': 'Cancelled Orders', 'Value': cancelledOrders },
                    { 'Metric': '', 'Value': '' },
                    { 'Metric': 'TOP 5 BEST-SELLING PRODUCTS', 'Value': '' },
                    { 'Metric': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'Value': 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' },
                ];

                topProducts.forEach((item, idx) => {
                    summaryData.push({
                        'Metric': `${idx + 1}. ${item[0]}`,
                        'Value': `${item[1].quantity} units (${item[1].revenue.toLocaleString()} EGP)`
                    });
                });

                summaryData.push({ 'Metric': '', 'Value': '' });
                summaryData.push({
                    'Metric': 'Report Generated',
                    'Value': new Date().toLocaleString('en-US')
                });

                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                summarySheet['!cols'] = [{ wch: 35 }, { wch: 40 }];

                XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary & Analytics');

                // ==================== Export File ====================
                const fileName = `YouCan-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Export Successful', `Data exported to ${fileName}`, 'success');

            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export Failed', 'Error exporting data: ' + error.message, 'error');
            }
        }

        // Helper function for English status
        function getStatusEnglish(status) {
            const map = {
                'pending': 'Pending',
                'processing': 'Processing',
                'shipped': 'Shipped',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return map[status] || status;
        }


        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));

            document.getElementById(section + '-section').classList.add('active');
            event.target.classList.add('active');

            if (section === 'dashboard') renderDashboard();
            if (section === 'orders') renderOrders();
            if (section === 'pos-sales') renderPOSSales();
            if (section === 'products') renderProducts();
            if (section === 'customers') renderCustomers();
        }

        function filterOrders(status) {
            renderOrders(status);
        }

        function filterPOSSales(filter) {
            renderPOSSales(filter);
        }

        function refreshDashboard() {
            renderDashboard();
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            renderDashboard();
            // Check for new orders every 30 seconds
            setInterval(checkNewOrders, 30000);
        });
    </script>
    <script>
        // ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© <script> ÙÙŠ dashboard.html
        window.addEventListener('DOMContentLoaded', () => {
            const adminUser = sessionStorage.getItem('adminUser');
            if (!adminUser) {
                window.location.href = 'admin-auth.html';
                return;
            }

            // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const user = JSON.parse(adminUser);
            document.querySelector('.sidebar-subtitle').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.full_name}`;

            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯...
            renderDashboard();
            setInterval(checkNewOrders, 30000);
        });
        // ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                sessionStorage.clear();
                window.location.href = 'admin-auth.html'; // Ø£Ùˆ pos-login.html Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
            }
        }

    </script>
</body>

</html>
